<!DOCTYPE html>
<html>
<head>
    <title>Analysis Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .btn-outline-custom { color: #764ba2; border-color: #764ba2; }
        .btn-outline-custom:hover { background-color: #764ba2; color: white; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .ai-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .text-warning { color: #fd7e14 !important; } 
    </style>
</head>
<body>

<div class="container mt-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'dashboard' %}" class="btn btn-outline-custom">&larr; Back to Dashboard</a>

        {% if email.recipient == request.user %}
        <a href="{% url 'compose_email' %}?to={{ email.sender.username }}&subject=Re: {{ email.subject }}" 
           class="btn btn-primary px-4 shadow-sm" style="background-color: #764ba2; border:none;">
           Reply to {{ email.sender.first_name }} ↩
        </a>
        {% endif %}
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card h-100">
                <div class="card-header bg-white border-bottom-0 pt-4 ps-4">
                    <h5 class="mb-0 text-secondary">Original Message</h5>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <small class="text-muted d-block">From</small>
                        <strong>{{ email.sender.first_name }} {{ email.sender.last_name }}</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Subject</small>
                        <strong>{{ email.subject }}</strong>
                    </div>
                    <hr class="my-4 text-muted">
                    <p class="card-text text-secondary" style="white-space: pre-wrap; line-height: 1.6;">{{ email.body }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            {% if email.is_analyzed %}
            <div class="card">
                <div class="card-header ai-header d-flex justify-content-between align-items-center p-3">
                    <h5 class="mb-0">✨ AI Intelligence Report</h5>
                    <span class="badge bg-white text-primary">{{ email.analysis.sentiment }}</span>
                </div>
                <div class="card-body p-4">
                    <div class="row mb-4 text-center">
                        <div class="col-4">
                            <div class="p-3 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">Risk Score</small>
                                
                                <h3 class="mb-0 
                                    {% if email.analysis.risk_score > 70 %}text-danger
                                    {% elif email.analysis.risk_score > 50 %}text-warning
                                    {% else %}text-success{% endif %}">
                                    {{ email.analysis.risk_score }}
                                </h3>

                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">Tone</small>
                                <h5 class="mb-0 text-dark">{{ email.analysis.tone }}</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded-3">
                                <small class="text-muted d-block mb-1">Category</small>
                                <h5 class="mb-0 text-dark text-capitalize">{{ email.analysis.suggested_category }}</h5>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-light border-start border-4 border-info shadow-sm mb-4">
                        <strong class="text-info">AI Summary:</strong> {{ email.analysis.summary }}
                    </div>

                    <div>
                        <h6 class="fw-bold text-secondary mb-3">Suggested Response (Draft)</h6>
                        <div class="position-relative">
                            <textarea class="form-control bg-light" rows="6" style="border: none;">{{ email.analysis.suggested_reply }}</textarea>
                        </div>
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-success px-4">Approve & Send</button>
                            <button class="btn btn-outline-secondary">Edit Draft</button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning d-flex align-items-center shadow-sm">
                <div>
                    <strong>Analysis Pending.</strong> The AI is currently processing this message...
                </div>
                <a href="{% url 'analyze_email' email.id %}" class="btn btn-warning btn-sm ms-auto fw-bold">Run Analysis Now</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

</body>
</html>